# Next.js PageBuilder — Build Workflow

<!--
  version:  1.0
  updated:  2026-02-23
  purpose:  Step-by-step build sequence for generating Next.js page data files
  parallel: knowledge/mcp/mcp-workflow.md (same role, different output target)
-->

> This workflow generates TypeScript page data files that the marketing team's Next.js PageBuilder app consumes. It does NOT create live pages — it produces code that the marketing team deploys.

---

## Build Sequence

### Use Case Page Generation

```
1. READ messaging file
   → knowledge/messaging/use-cases/{slug}.md
   → Extract all 8 sections: hook, problem, foundation, solution, before_after,
     knowledge_graph, social_proof, cta, seo

2. READ block reference
   → knowledge/nextjs/nextjs-block-reference.md
   → Load block type interfaces and field mapping tables

3. READ brand guide
   → knowledge/branding/improvado-agent.md
   → Load banned words, tone rules, approved phrases

4. READ page spec (for structural context)
   → knowledge/pages/use-case.md
   → Confirm 8-section structure and section rhythm

5. TRANSFORM each messaging section → block object(s)
   → Follow the field mapping tables exactly
   → Apply theme assignments per the alternation pattern
   → Strip markdown prefixes (e.g., "- → " from pain bullets)
   → Parse tables into structured arrays
   → Preserve **accent** markup in headlines

6. ASSEMBLE page data object
   → Set _id, title, slug from messaging seo section
   → Set theme to 'dark' (page-level default matches hero)
   → Set seo fields from messaging seo section
   → Order content array: S1 → S2 → S3a → S3b → S4 → S5 → S6 → S7 → S8

7. VALIDATE before writing
   → All 8 sections present (S3 produces 2 blocks, S7 may produce 2)
   → No banned words in any string value
   → Word counts: hero title 8–12, hero subtitle 20–30, CTA title 8–14
   → Theme alternation: dark → light → dark(x2) → light → warm → dark → light → dark
   → All required fields non-empty
   → _key values unique across content array
   → **accent** markup preserved in hero title

8. WRITE output file
   → output/nextjs/pages/use-cases/{slug}.ts
   → Export as: export const page = { ... }
   → Include type annotation comment at top

9. RUN QA (optional)
   → Invoke @orchestrator in nextjs mode
   → Target: the generated .ts file
```

### Homepage Generation

```
1. READ homepage spec
   → knowledge/pages/homepage.md

2. READ core messaging
   → knowledge/messaging/core/knowledge-graph.md

3. READ section guides (for each section being built)
   → knowledge/sections/hero.md
   → knowledge/sections/pain.md
   → knowledge/sections/solution-steps.md
   → knowledge/sections/product-features.md
   → knowledge/sections/testimonials.md
   → knowledge/sections/enterprise-trust.md

4. READ block reference + brand guide (same as use case flow)

5. TRANSFORM each homepage section → block object(s)
   → See homepage mapping table in nextjs-block-reference.md

6–9. Same as use case flow (assemble, validate, write, QA)
   → Output: output/nextjs/pages/homepage.ts
```

---

## Output File Format

```typescript
// Generated by nextjs-generator from knowledge/messaging/use-cases/{slug}.md
// Do not edit directly — regenerate from messaging file if changes needed.

import type { Page } from '@/types/page'

export const page: Page = {
  _id: '{slug}',
  title: '{Use Case Name}',
  slug: { current: '{slug}' },
  theme: 'dark',
  seo: {
    metaTitle: '{seo.title}',
    metaDescription: '{seo.description}'
  },
  content: [
    // S1–S8 block objects in order
  ]
}

// Register in pagesMap:
// import { page as {camelCase} } from './use-cases/{slug}'
// export const pagesMap = { ..., '{slug}': {camelCase} }
```

---

## Rules

1. **All text comes from messaging files.** Never invent copy. If a field is empty in the messaging file, leave it empty or omit the optional field.

2. **Banned words check is mandatory.** Scan every string value before writing. If found, flag it — do not silently replace (the messaging file should be fixed at source).

3. **Theme alternation is structural.** Don't assign themes based on aesthetics — follow the pattern in the block reference.

4. **Preserve markdown formatting.** The `**accent**` markers in headlines, the `>` blockquote syntax in callouts — these are meaningful to the PageBuilder rendering layer.

5. **Strip messaging-specific prefixes.** Pain bullets start with `- → ` in the messaging file — strip to just the text. Table rows should be parsed into structured objects.

6. **One file per page.** Each use case generates one `.ts` file. Don't merge multiple pages into one file.

7. **Generated files are artifacts.** They live in `output/nextjs/` and should never be manually edited in this repo. To change content, update the messaging file and regenerate.

8. **Comments for traceability.** Include a header comment noting the source messaging file path and generation date.

---

## Common Mistakes

| Mistake | Result | Fix |
|---|---|---|
| Leaving `- → ` prefix on pain bullets | Extra characters in rendered text | Strip prefix: `bullet.replace(/^- → /, '')` |
| Forgetting the S3 split | Foundation section generates only 1 block | Always produce both `platformBlock` and `resultsBlock` for S3 |
| Hardcoding theme on every block | Breaks if page rhythm changes | Follow the mapping table, not visual preference |
| Skipping word count validation | Hero title too long/short | Check before writing: split on spaces, count |
| Missing `_key` on blocks | PageBuilder rendering errors | Every block needs a unique `_key` |
| Not parsing markdown tables | Raw markdown in block fields | Parse `\| col1 \| col2 \|` rows into structured objects |
| Generating copy not in messaging file | Content drift from source of truth | Only use text from the messaging file |

---

## Verification Checklist

After generating a page file, verify:

- [ ] File exports a `page` object with correct shape
- [ ] `_id` matches slug
- [ ] `seo.metaTitle` and `seo.metaDescription` populated
- [ ] Content array has 9–10 blocks (8 sections, S3 produces 2, S7 may produce 2)
- [ ] Block types match the mapping table for each section
- [ ] Theme alternation follows the prescribed pattern
- [ ] No banned words in any string value
- [ ] Hero title word count: 8–12
- [ ] Hero subtitle word count: 20–30
- [ ] CTA title word count: 8–14
- [ ] All `_key` values unique
- [ ] `**accent**` markup present in hero title
- [ ] Pain bullet prefixes stripped
- [ ] Foundation source groups parsed into structured objects
- [ ] Setup times parsed into stats array
